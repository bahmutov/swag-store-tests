name: ci
on:
  push:
  workflow_dispatch:
    inputs:
      testIds:
        description: |
          Comma-separated list of data test ids in the source files
        required: false
        type: string

jobs:
  e2e:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout üõéÔ∏è
        # https://github.com/actions/checkout
        uses: actions/checkout@v4

      - name: Check out the app üõéÔ∏è
        uses: actions/checkout@v4
        with:
          # todo: pass the correct reference
          # to check out the right branch / commit
          repository: bahmutov/swag-store
          path: swag-store
          token: ${{ secrets.SWAG_REPO_GH_TOKEN }}

      - name: Show the source files
        run: |
          ls -la
          ls -la swag-store

      # https://github.com/cypress-io/github-action
      - name: Install dependencies in this repo üì¶
        uses: cypress-io/github-action@v6
        with:
          runTests: false

      - name: Install app dependencies üì¶
        # https://github.com/bahmutov/npm-install
        uses: bahmutov/npm-install@v1
        with:
          working-directory: swag-store

      - name: Start the app
        run: npm start &
        working-directory: swag-store

      - name: Find specs for test ids
        if: ${{ github.event.inputs.testIds }}
        id: find-specs
        run: |
          npx find-ids --test-ids ${{ github.event.inputs.testIds }} \
            --specs 'cypress/e2e/**/*.cy.js' --command getByTestId,containsTestId \
            --set-gha-outputs

      - name: Run found E2E tests
        if: ${{ steps.find-specs.outputs.specsToRunN }}
        timeout-minutes: 3
        uses: cypress-io/github-action@v6
        with:
          install: false
          wait-on: 'http://localhost:3000'
          record: true
          spec: ${{ steps.find-specs.outputs.specsToRun }}
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}

      - name: Run all E2E tests
        if: ${{ !steps.find-specs.outputs.specsToRunN }}
        timeout-minutes: 3
        uses: cypress-io/github-action@v6
        with:
          install: false
          wait-on: 'http://localhost:3000'
          record: true
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
